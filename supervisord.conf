; Supervisor configuration untuk Turnitin Bypass API
; Install supervisor: pip install supervisor
; Run: supervisord -c supervisord.conf
; Control: supervisorctl -c supervisord.conf status

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[supervisord]
logfile=logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=pids/supervisord.pid
nodaemon=false
minfds=1024
minprocs=200

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

; ============================================================================
; Redis Server
; ============================================================================
[program:redis]
command=redis-server
directory=/workspaces/vision-computer
autostart=true
autorestart=true
stdout_logfile=logs/redis.log
stderr_logfile=logs/redis_error.log
priority=1
startsecs=5
stopwaitsecs=10

; ============================================================================
; FastAPI Application (Gunicorn + Uvicorn Workers)
; ============================================================================
[program:fastapi]
command=gunicorn app.main:app
    --workers 4
    --worker-class uvicorn.workers.UvicornWorker
    --bind 0.0.0.0:8000
    --timeout 300
    --keep-alive 5
    --log-level info
    --access-logfile logs/access.log
    --error-logfile logs/error.log
directory=/workspaces/vision-computer
environment=PATH="/usr/local/bin:/usr/bin:/bin"
autostart=true
autorestart=true
stdout_logfile=logs/api.log
stderr_logfile=logs/api_error.log
priority=2
startsecs=10
stopwaitsecs=30

; ============================================================================
; Celery Workers
; ============================================================================
[program:celery_worker]
command=celery -A app.celery_app worker
    --loglevel=info
    --concurrency=4
    --pool=prefork
    --queues=unified,analysis,matching,bypass
    --max-tasks-per-child=10
    --time-limit=600
    --soft-time-limit=540
directory=/workspaces/vision-computer
environment=PATH="/usr/local/bin:/usr/bin:/bin"
autostart=true
autorestart=true
stdout_logfile=logs/celery_worker.log
stderr_logfile=logs/celery_worker_error.log
priority=3
startsecs=10
stopwaitsecs=60
stopasgroup=true
killasgroup=true

; ============================================================================
; Process Groups (untuk kontrol multiple services sekaligus)
; ============================================================================
[group:turnitin-bypass]
programs=redis,fastapi,celery_worker
priority=999
